- name: Fetch Vouch CA public key from {{ vouch_instance_url }}
  ansible.builtin.uri:
    url: "{{ vouch_instance_url }}{{ vouch_ca_public_key_endpoint }}"
    return_content: true
  register: vouch_ca_response

- name: Install Vouch CA public key
  ansible.builtin.copy:
    content: "{{ vouch_ca_response.content }}"
    dest: "{{ vouch_ca_key_path }}"
    owner: root
    group: root
    mode: "0644"
  notify: Restart sshd

- name: Install authorized principals command
  ansible.builtin.template:
    src: vouch-authorized-principals.j2
    dest: "{{ vouch_principals_command_path }}"
    owner: root
    group: root
    mode: "0755"
  when: vouch_allowed_domains | length > 0 or vouch_authorized_principals | length > 0
  notify: Restart sshd

- name: Write allowed domains file
  ansible.builtin.copy:
    content: "{{ vouch_allowed_domains | join('\n') }}\n"
    dest: /etc/ssh/vouch-allowed-domains
    owner: root
    group: root
    mode: "0644"
  when: vouch_allowed_domains | length > 0
  notify: Restart sshd

- name: Remove allowed domains file when no domains configured
  ansible.builtin.file:
    path: /etc/ssh/vouch-allowed-domains
    state: absent
  when: vouch_allowed_domains | length == 0

- name: Create sshd config drop-in for Vouch CA
  ansible.builtin.template:
    src: vouch-ca.conf.j2
    dest: "{{ vouch_sshd_config_path }}"
    owner: root
    group: root
    mode: "0644"
    validate: "sshd -t -f %s"
  notify: Restart sshd

- name: Create authorized principals directory
  ansible.builtin.file:
    path: "{{ vouch_authorized_principals_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  when: vouch_authorized_principals | length > 0

- name: Write per-user authorized principals files
  ansible.builtin.copy:
    content: "{{ item.value | join('\n') }}\n"
    dest: "{{ vouch_authorized_principals_dir }}/{{ item.key }}"
    owner: root
    group: root
    mode: "0644"
  loop: "{{ vouch_authorized_principals | dict2items }}"
  when: vouch_authorized_principals | length > 0

- name: Initialize revoked keys file
  ansible.builtin.file:
    path: "{{ vouch_revoked_keys_path }}"
    state: touch
    owner: root
    group: root
    mode: "0644"
    modification_time: preserve
    access_time: preserve
